name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  integration-tests:
    runs-on: ubuntu-latest

    services:
      api:
        image: python:3.11
        options: >-
          --health-cmd="curl -f http://localhost:8001/health || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 8001:8001

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install backend dependencies
      run: |
        cd ctsr-api
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Start API server
      run: |
        cd ctsr-api
        python main.py &
        sleep 10
      continue-on-error: true

    - name: Install frontend dependencies
      run: |
        cd streamlit-app
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Test API endpoints
      run: |
        python -m pip install httpx
        python << 'EOF'
        import httpx
        import time
        
        # Wait for API to be ready
        time.sleep(5)
        
        client = httpx.Client()
        try:
            response = client.get("http://localhost:8001/health", timeout=5.0)
            print(f"API Health: {response.status_code}")
            print(response.json())
        except Exception as e:
            print(f"API not ready: {e}")
        finally:
            client.close()
        EOF

    - name: Run integration tests
      run: |
        cd streamlit-app
        if [ -d "tests" ] && [ -f "tests/test_integration.py" ]; then
          pytest tests/test_integration.py -v
        else
          echo "No integration tests found"
        fi
      continue-on-error: true
