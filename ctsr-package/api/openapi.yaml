openapi: 3.1.0
info:
  title: Clinical Trial Systems Register (CTSR) API
  description: |
    REST API for the Clinical Trial Systems Register - maintaining inventory of 
    computerized systems used in clinical trials per ICH E6(R3) requirements.
    
    ## Authentication
    All endpoints require Bearer token authentication via Azure AD / Entra ID.
  version: 1.1.0
  contact:
    name: R&D IT Architecture

servers:
  - url: https://ctsr-dev.novonordisk.com/api/v1
    description: Development
  - url: https://ctsr.novonordisk.com/api/v1
    description: Production

tags:
  - name: Health
    description: Service health
  - name: Lookups
    description: Reference data
  - name: Vendors
    description: Vendor management
  - name: Systems
    description: System instance catalog
  - name: Trials
    description: Clinical trials
  - name: Trial Systems
    description: Link systems to trials
  - name: Confirmations
    description: Periodic and DB lock confirmations
  - name: Exports
    description: eTMF export generation
  - name: Admin
    description: Administration and monitoring

security:
  - bearerAuth: []

paths:
  # ===========================================================================
  # Health (1 endpoint)
  # ===========================================================================
  /health:
    get:
      operationId: getHealth
      tags: [Health]
      summary: Service health and readiness
      security: []
      responses:
        '200':
          description: Service healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded, unhealthy]
                  database:
                    type: string
                  timestamp:
                    type: string
                    format: date-time

  # ===========================================================================
  # Lookups (1 endpoint)
  # ===========================================================================
  /lookups:
    get:
      operationId: getLookups
      tags: [Lookups]
      summary: Get all reference data
      description: Returns all lookup tables for client-side caching
      responses:
        '200':
          description: All lookup data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LookupsResponse'

  # ===========================================================================
  # Vendors (4 endpoints)
  # ===========================================================================
  /vendors:
    get:
      operationId: listVendors
      tags: [Vendors]
      summary: List vendors
      parameters:
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
        - name: vendor_type
          in: query
          schema:
            type: string
        - name: is_active
          in: query
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Vendor list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VendorListResponse'

    post:
      operationId: createVendor
      tags: [Vendors]
      summary: Create vendor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VendorCreate'
      responses:
        '201':
          description: Vendor created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vendor'

  /vendors/{vendor_id}:
    get:
      operationId: getVendor
      tags: [Vendors]
      summary: Get vendor details
      parameters:
        - $ref: '#/components/parameters/vendorIdParam'
      responses:
        '200':
          description: Vendor details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vendor'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      operationId: updateVendor
      tags: [Vendors]
      summary: Update vendor
      parameters:
        - $ref: '#/components/parameters/vendorIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VendorUpdate'
      responses:
        '200':
          description: Vendor updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vendor'

  # ===========================================================================
  # Systems (4 endpoints)
  # ===========================================================================
  /systems:
    get:
      operationId: listSystems
      tags: [Systems]
      summary: List system instances
      parameters:
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
        - name: category_code
          in: query
          schema:
            type: string
        - name: validation_status
          in: query
          schema:
            type: string
        - name: data_hosting_region
          in: query
          schema:
            type: string
        - name: vendor_id
          in: query
          schema:
            type: string
            format: uuid
        - name: search
          in: query
          schema:
            type: string
        - name: is_active
          in: query
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: System list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemListResponse'

    post:
      operationId: createSystem
      tags: [Systems]
      summary: Create system instance
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SystemCreate'
      responses:
        '201':
          description: System created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemInstance'

  /systems/{instance_id}:
    get:
      operationId: getSystem
      tags: [Systems]
      summary: Get system details
      description: Returns system with linked trials and change history
      parameters:
        - $ref: '#/components/parameters/instanceIdParam'
      responses:
        '200':
          description: System details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemDetail'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      operationId: updateSystem
      tags: [Systems]
      summary: Update system instance
      parameters:
        - $ref: '#/components/parameters/instanceIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SystemUpdate'
      responses:
        '200':
          description: System updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemInstance'

  # ===========================================================================
  # Trials (2 endpoints)
  # ===========================================================================
  /trials:
    get:
      operationId: listTrials
      tags: [Trials]
      summary: List trials
      parameters:
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
        - name: trial_status
          in: query
          schema:
            type: string
            enum: [PLANNED, ACTIVE, DB_LOCKED, CLOSED]
        - name: confirmation_status
          in: query
          schema:
            type: string
            enum: [OK, DUE_SOON, OVERDUE]
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Trial list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrialListResponse'

  /trials/{trial_id}:
    get:
      operationId: getTrial
      tags: [Trials]
      summary: Get trial details
      description: Returns trial with linked systems and confirmation status
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
      responses:
        '200':
          description: Trial details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrialDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  # ===========================================================================
  # Trial Systems (4 endpoints)
  # ===========================================================================
  /trials/{trial_id}/systems:
    get:
      operationId: listTrialSystems
      tags: [Trial Systems]
      summary: List systems linked to trial
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
      responses:
        '200':
          description: Linked systems
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrialSystemListResponse'

    post:
      operationId: linkSystem
      tags: [Trial Systems]
      summary: Link system to trial
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LinkSystemRequest'
      responses:
        '201':
          description: System linked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrialSystemLink'

  /trials/{trial_id}/systems/{link_id}:
    put:
      operationId: updateTrialSystem
      tags: [Trial Systems]
      summary: Update system link
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
        - $ref: '#/components/parameters/linkIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLinkRequest'
      responses:
        '200':
          description: Link updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrialSystemLink'

    delete:
      operationId: unlinkSystem
      tags: [Trial Systems]
      summary: Unlink system from trial
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
        - $ref: '#/components/parameters/linkIdParam'
      responses:
        '204':
          description: System unlinked

  # ===========================================================================
  # Confirmations (3 endpoints)
  # ===========================================================================
  /trials/{trial_id}/confirmations:
    get:
      operationId: listConfirmations
      tags: [Confirmations]
      summary: List trial confirmations
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
      responses:
        '200':
          description: Confirmation history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationListResponse'

    post:
      operationId: createConfirmation
      tags: [Confirmations]
      summary: Submit confirmation
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmationRequest'
      responses:
        '201':
          description: Confirmation created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Confirmation'

  /trials/{trial_id}/confirmations/{confirmation_id}:
    get:
      operationId: getConfirmation
      tags: [Confirmations]
      summary: Get confirmation details with snapshots
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
        - $ref: '#/components/parameters/confirmationIdParam'
      responses:
        '200':
          description: Confirmation details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationDetail'

  # ===========================================================================
  # Exports (2 endpoints)
  # ===========================================================================
  /trials/{trial_id}/exports:
    post:
      operationId: createExport
      tags: [Exports]
      summary: Generate eTMF export
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportRequest'
      responses:
        '201':
          description: Export created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportResponse'

  /trials/{trial_id}/exports/{export_id}:
    get:
      operationId: getExport
      tags: [Exports]
      summary: Get export status and download links
      parameters:
        - $ref: '#/components/parameters/trialIdParam'
        - $ref: '#/components/parameters/exportIdParam'
      responses:
        '200':
          description: Export with download links
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportResponse'

  # ===========================================================================
  # Admin (3 endpoints)
  # ===========================================================================
  /admin/dashboard:
    get:
      operationId: getDashboard
      tags: [Admin]
      summary: Dashboard statistics and alerts
      responses:
        '200':
          description: Dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardResponse'

  /admin/uploads:
    get:
      operationId: listUploads
      tags: [Admin]
      summary: List vendor uploads
      parameters:
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
        - name: vendor_code
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDING, PROCESSING, COMPLETED, FAILED]
      responses:
        '200':
          description: Upload list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadListResponse'

  /admin/uploads/{upload_id}:
    get:
      operationId: getUpload
      tags: [Admin]
      summary: Get upload details
      parameters:
        - $ref: '#/components/parameters/uploadIdParam'
      responses:
        '200':
          description: Upload details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadDetail'

# =============================================================================
# Components
# =============================================================================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    limitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    offsetParam:
      name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0

    vendorIdParam:
      name: vendor_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    instanceIdParam:
      name: instance_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    trialIdParam:
      name: trial_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    linkIdParam:
      name: link_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    confirmationIdParam:
      name: confirmation_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    exportIdParam:
      name: export_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    uploadIdParam:
      name: upload_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    # -------------------------------------------------------------------------
    # Common
    # -------------------------------------------------------------------------
    Error:
      type: object
      required: [error, message]
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object

    PaginationMeta:
      type: object
      properties:
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # -------------------------------------------------------------------------
    # Lookups
    # -------------------------------------------------------------------------
    LookupsResponse:
      type: object
      properties:
        system_categories:
          type: array
          items:
            $ref: '#/components/schemas/SystemCategory'
        validation_statuses:
          type: array
          items:
            $ref: '#/components/schemas/ValidationStatus'
        criticality_levels:
          type: array
          items:
            $ref: '#/components/schemas/Criticality'
        vendor_types:
          type: array
          items:
            type: string
        hosting_models:
          type: array
          items:
            type: string
        data_hosting_regions:
          type: array
          items:
            type: string

    SystemCategory:
      type: object
      properties:
        category_code:
          type: string
        category_name:
          type: string
        default_criticality:
          type: string

    ValidationStatus:
      type: object
      properties:
        status_code:
          type: string
        status_name:
          type: string
        requires_attention:
          type: boolean

    Criticality:
      type: object
      properties:
        criticality_code:
          type: string
        criticality_name:
          type: string

    # -------------------------------------------------------------------------
    # Vendors
    # -------------------------------------------------------------------------
    Vendor:
      type: object
      properties:
        vendor_id:
          type: string
          format: uuid
        vendor_code:
          type: string
        vendor_name:
          type: string
        vendor_type:
          type: string
        contact_name:
          type: string
        contact_email:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time

    VendorCreate:
      type: object
      required: [vendor_code, vendor_name, vendor_type]
      properties:
        vendor_code:
          type: string
        vendor_name:
          type: string
        vendor_type:
          type: string
        contact_name:
          type: string
        contact_email:
          type: string

    VendorUpdate:
      type: object
      properties:
        vendor_name:
          type: string
        vendor_type:
          type: string
        contact_name:
          type: string
        contact_email:
          type: string
        is_active:
          type: boolean

    VendorListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Vendor'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # -------------------------------------------------------------------------
    # Systems
    # -------------------------------------------------------------------------
    SystemInstance:
      type: object
      properties:
        instance_id:
          type: string
          format: uuid
        instance_code:
          type: string
        platform_vendor_name:
          type: string
        service_provider_name:
          type: string
        category_code:
          type: string
        category_name:
          type: string
        platform_name:
          type: string
        platform_version:
          type: string
        validation_status_code:
          type: string
        validation_date:
          type: string
          format: date
        validation_expiry:
          type: string
          format: date
        data_hosting_region:
          type: string
        hosting_model:
          type: string
        is_active:
          type: boolean

    SystemDetail:
      allOf:
        - $ref: '#/components/schemas/SystemInstance'
        - type: object
          properties:
            description:
              type: string
            supported_studies:
              type: array
              items:
                type: string
            interfaces:
              type: array
              items:
                $ref: '#/components/schemas/Interface'
            validation_evidence_link:
              type: string
            part11_compliant:
              type: boolean
            annex11_compliant:
              type: boolean
            soc2_certified:
              type: boolean
            iso27001_certified:
              type: boolean
            linked_trials:
              type: array
              items:
                $ref: '#/components/schemas/LinkedTrialSummary'
            change_history:
              type: array
              items:
                $ref: '#/components/schemas/ChangeRecord'

    Interface:
      type: object
      properties:
        system_name:
          type: string
        direction:
          type: string
          enum: [INBOUND, OUTBOUND, BIDIRECTIONAL]
        data_type:
          type: string

    LinkedTrialSummary:
      type: object
      properties:
        trial_id:
          type: string
          format: uuid
        protocol_number:
          type: string
        trial_status:
          type: string
        criticality_code:
          type: string

    ChangeRecord:
      type: object
      properties:
        changed_at:
          type: string
          format: date-time
        changed_by:
          type: string
        action:
          type: string
        changes:
          type: object

    SystemCreate:
      type: object
      required: [instance_code, platform_name, category_code, validation_status_code, hosting_model, data_hosting_region]
      properties:
        instance_code:
          type: string
        platform_vendor_id:
          type: string
          format: uuid
        service_provider_id:
          type: string
          format: uuid
        category_code:
          type: string
        platform_name:
          type: string
        platform_version:
          type: string
        validation_status_code:
          type: string
        hosting_model:
          type: string
        data_hosting_region:
          type: string

    SystemUpdate:
      type: object
      properties:
        platform_version:
          type: string
        validation_status_code:
          type: string
        validation_date:
          type: string
          format: date
        validation_expiry:
          type: string
          format: date
        is_active:
          type: boolean

    SystemListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SystemInstance'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # -------------------------------------------------------------------------
    # Trials
    # -------------------------------------------------------------------------
    Trial:
      type: object
      properties:
        trial_id:
          type: string
          format: uuid
        protocol_number:
          type: string
        trial_title:
          type: string
        trial_phase:
          type: string
        trial_status:
          type: string
        therapeutic_area:
          type: string
        trial_lead_name:
          type: string
        next_confirmation_due:
          type: string
          format: date
        confirmation_status:
          type: string
          enum: [OK, DUE_SOON, OVERDUE]
        systems_count:
          type: integer

    TrialDetail:
      allOf:
        - $ref: '#/components/schemas/Trial'
        - type: object
          properties:
            linked_systems:
              type: array
              items:
                $ref: '#/components/schemas/TrialSystemLink'
            confirmations:
              type: array
              items:
                $ref: '#/components/schemas/Confirmation'

    TrialListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Trial'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # -------------------------------------------------------------------------
    # Trial System Links
    # -------------------------------------------------------------------------
    TrialSystemLink:
      type: object
      properties:
        link_id:
          type: string
          format: uuid
        instance_id:
          type: string
          format: uuid
        instance_code:
          type: string
        platform_name:
          type: string
        category_code:
          type: string
        validation_status_code:
          type: string
        criticality_code:
          type: string
        assignment_status:
          type: string
        usage_start_date:
          type: string
          format: date

    LinkSystemRequest:
      type: object
      required: [instance_id]
      properties:
        instance_id:
          type: string
          format: uuid
        criticality_code:
          type: string
        criticality_override_reason:
          type: string
        usage_start_date:
          type: string
          format: date

    UpdateLinkRequest:
      type: object
      properties:
        criticality_code:
          type: string
        criticality_override_reason:
          type: string
        usage_end_date:
          type: string
          format: date

    TrialSystemListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TrialSystemLink'

    # -------------------------------------------------------------------------
    # Confirmations
    # -------------------------------------------------------------------------
    Confirmation:
      type: object
      properties:
        confirmation_id:
          type: string
          format: uuid
        confirmation_type:
          type: string
          enum: [PERIODIC, DB_LOCK]
        confirmation_status:
          type: string
        due_date:
          type: string
          format: date
        confirmed_date:
          type: string
          format: date
        confirmed_by:
          type: string
        systems_count:
          type: integer

    ConfirmationDetail:
      allOf:
        - $ref: '#/components/schemas/Confirmation'
        - type: object
          properties:
            notes:
              type: string
            snapshots:
              type: array
              items:
                $ref: '#/components/schemas/LinkSnapshot'

    LinkSnapshot:
      type: object
      properties:
        instance_code:
          type: string
        platform_name:
          type: string
        validation_status_at:
          type: string
        platform_version_at:
          type: string

    ConfirmationRequest:
      type: object
      required: [confirmation_type]
      properties:
        confirmation_type:
          type: string
          enum: [PERIODIC, DB_LOCK]
        notes:
          type: string

    ConfirmationListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Confirmation'

    # -------------------------------------------------------------------------
    # Exports
    # -------------------------------------------------------------------------
    ExportRequest:
      type: object
      properties:
        formats:
          type: array
          items:
            type: string
            enum: [CSV, PDF]
          default: [CSV, PDF]

    ExportResponse:
      type: object
      properties:
        export_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [PENDING, COMPLETED, FAILED]
        csv_url:
          type: string
        pdf_url:
          type: string
        expires_at:
          type: string
          format: date-time

    # -------------------------------------------------------------------------
    # Admin
    # -------------------------------------------------------------------------
    DashboardResponse:
      type: object
      properties:
        total_systems:
          type: integer
        systems_by_category:
          type: object
          additionalProperties:
            type: integer
        validation_alerts:
          type: array
          items:
            $ref: '#/components/schemas/ValidationAlert'
        confirmations_due:
          type: array
          items:
            $ref: '#/components/schemas/ConfirmationDue'
        recent_uploads:
          type: array
          items:
            $ref: '#/components/schemas/UploadSummary'

    ValidationAlert:
      type: object
      properties:
        instance_id:
          type: string
          format: uuid
        instance_code:
          type: string
        validation_status:
          type: string
        validation_expiry:
          type: string
          format: date
        linked_trials_count:
          type: integer

    ConfirmationDue:
      type: object
      properties:
        trial_id:
          type: string
          format: uuid
        protocol_number:
          type: string
        due_date:
          type: string
          format: date
        days_until_due:
          type: integer
        is_overdue:
          type: boolean

    UploadSummary:
      type: object
      properties:
        upload_id:
          type: string
          format: uuid
        vendor_code:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        instances_processed:
          type: integer

    UploadDetail:
      allOf:
        - $ref: '#/components/schemas/UploadSummary'
        - type: object
          properties:
            instances_created:
              type: integer
            instances_updated:
              type: integer
            validation_errors:
              type: array
              items:
                type: object

    UploadListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/UploadSummary'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
